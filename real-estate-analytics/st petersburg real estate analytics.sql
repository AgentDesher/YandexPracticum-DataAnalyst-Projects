-- 1. Время активности объявлений. 
-- Определим аномальные значения (выбросы) по значению перцентилей:
with limits as (
    select  
        percentile_disc(0.99) within group (order by total_area) as total_area_limit,
        percentile_disc(0.99) within group (order by rooms) as rooms_limit,
        percentile_disc(0.99) within group (order by balcony) as balcony_limit,
        percentile_disc(0.99) within group (order by ceiling_height) as ceiling_height_limit_h,
        percentile_disc(0.01) within group (order by ceiling_height) as ceiling_height_limit_l
    from real_estate.flats     
),
-- найдём id объявлений, которые не содержат выбросы:
filtered_id as(
    select id
    from real_estate.flats  
    where 
        total_area < (select total_area_limit from limits)
        and (rooms < (select rooms_limit from limits) or rooms is null)
        and (balcony < (select balcony_limit from limits) or balcony is null)
        and ((ceiling_height < (select ceiling_height_limit_h from limits)
            and ceiling_height > (select ceiling_height_limit_l from limits)) or ceiling_height is null))          
-- основной запрос
select  
	   case 
	   	when city = 'Санкт-Петербург' then 'Санкт-петербург'
	   	else 'Лен область'
	   end as "Регион",	   
	   case 
	   	when days_exposition <= 31 and days_exposition >= 1 then 'до месяца'
	   	when days_exposition <= 92 and days_exposition > 31 then 'до квартала'
	   	when days_exposition <= 182 and days_exposition > 92 then 'до полугода'
	   	when days_exposition > 182  and  days_exposition < 1585 then 'до года'
	   	when days_exposition is null then 'незакрытые объявления'
	   end as "Период",
	   count(id) as "Кол-во объявлений", 
	   round(avg(last_price / total_area)) as "Средняя цена кв. м",
	   round(avg(total_area)) as "Средняя полощадь"
	   -- round(percentile_disc(0.5) within group (order by f.rooms)) as mediana_rooms,
	   -- round(percentile_disc(0.5) within group (order by f.balcony)) as mediana_balcony,
	   -- round(percentile_disc(0.5) within group (order by f.ceiling_height)) as mediana_ceiling_height,  
	   -- round(percentile_disc(0.5) within group (order by f.floors_total)) as mediana_floors_total,
	   -- round(percentile_disc(0.5) within group (order by f.floor)) as mediana_floor
from real_estate.advertisement a
left join real_estate.flats f using(id)
left join real_estate.city c using(city_id)
left join real_estate.type t using(type_id)
where id in (select * from filtered_id) 
  and t.type = 'город'
group by 1, 2
order by 3 desc, 1;
--
-- |Регион				|Период					|Кол-во объявлений|Средняя цена кв. м|Средняя полощадь|
-- |--------------------|-----------------------|-----------------|------------------|----------------|
-- |Санкт-петербург 	|до года				|			  3543|			 115423.0|			  66.0|
-- |Санкт-петербург 	|до квартала			|			  3285|			 111553.0|			  57.0|
-- |Санкт-петербург 	|до полугода			|			  2207|			 112099.0|			  61.0|
-- |Санкт-петербург 	|до месяца				|			  2204|			 110586.0|			  54.0|
-- |Санкт-петербург 	|незакрытые объявления 	|			  1554|			 134633.0|			  72.0|
-- |Лен область			|до квартала			|			   929|			  67341.0|			  51.0|
-- |Лен область			|до года				|			   874|			  68319.0|			  55.0|
-- |Лен область			|до полугода			|			   551|			  70097.0|			  52.0|
-- |Лен область			|незакрытые объявления 	|			   461|			  73626.0|			  58.0|
-- |Лен область			|до месяца				|			   406|			  73351.0|		      49.0|

-- 1) Самые распространённые категории объявлений
--    В Санкт-Петербурге больше всего объявлений закрываются в категории «до года» (3543) и «до квартала» (3285). 
--    Меньше всего — «незакрытые» (1554), однако именно они демонстрируют наивысшую цену за квадратный метр (134,6 тыс. ₽).

--	  В Ленинградской области доминирует категория «до квартала» (929), далее «до года» (874). Незакрытых объявлений — 461, 
-- 	  при средней цене 73,6 тыс. ₽ за кв. м.

-- 2) Характеристики недвижимости и время активности объявлений
-- 	  В Санкт-Петербурге ключевым фактором является цена: незакрытые квартиры стоят в среднем на 20% дороже, чем быстро реализуемые 
--    объекты. Дополнительно влияет площадь: быстрее продаются квартиры 54–57 м², а большие (72 м²) висят дольше.

--    В Ленинградской области ценовой фактор выражен слабее: закрытые и незакрытые квартиры стоят примерно одинаково. Здесь также 
--    быстрее находят покупателя компактные квартиры (49–52 м²), тогда как объекты свыше 55–58 м² продаются медленнее.

-- 3) Сравнение регионов
--    Санкт-Петербург дороже почти вдвое (110–115 тыс. ₽/м² против 67–73 тыс. ₽/м²). Продажи занимают больше времени: преобладают 
-- категории «до года» и «до полугода». 
--    В Ленинградской области рынок более динамичный: большинство объектов закрывается в пределах квартала.
--    В обоих регионах дольше всего продаются большие квартиры, но в Петербурге этот эффект усиливается высокой ценой.

-- Выводы
-- В Санкт-Петербурге наблюдается высокая цена за кв. м и более длительные сроки экспозиции, особенно у крупных квартир.
-- В Ленинградской области рынок более динамичный: большинство объектов реализуется в течение квартала, ценовые колебания влияют меньше.
-- Общие факторы, замедляющие продажу: высокая цена, большая площадь.

-- Рекомендации
-- Для продавцов в Санкт-Петербурге:
-- 		Корректировать цену больших объектов, использовать рассрочку или ипотечные программы.
-- 		Делать акцент на целевой аудитории семей для квартир 3–4 комнат.
-- 		Усилить маркетинговую поддержку дорогих объектов через таргетированную рекламу.
-- Для продавцов в Ленинградской области:
--  	Упор на типовые квартиры с оптимальной площадью: они быстрее находят покупателя.
--  	Для крупных объектов усиливать привлекательность через преимущества локации (транспорт, инфраструктура, экология).
-- Для агентств недвижимости:
--  	В Петербурге: запускать специальные кампании по ускорению продажи дорогих квартир, в том числе через цифровой маркетинг и 
--	    специальные условия кредитования.
--  	В Ленинградской области: формировать положительный имидж региона, продвигая новые транспортные проекты и развитие инфраструктуры.


-- 2. Сезонность объявлений
with limits as (
    select  
        percentile_disc(0.99) within group (order by total_area) as total_area_limit,
        percentile_disc(0.99) within group (order by rooms) as rooms_limit,
        percentile_disc(0.99) within group (order by balcony) as balcony_limit,
        percentile_disc(0.99) within group (order by ceiling_height) as ceiling_height_limit_h,
        percentile_disc(0.01) within group (order by ceiling_height) as ceiling_height_limit_l
    from real_estate.flats     
),
-- найдём id объявлений, которые не содержат выбросы:
  filtered_id as(
    select id
    from real_estate.flats  
    where 
        total_area < (select total_area_limit from limits)
        and (rooms < (select rooms_limit from limits) or rooms is null)
        and (balcony < (select balcony_limit from limits) or balcony is null)
        and ((ceiling_height < (select ceiling_height_limit_h from limits)
        and ceiling_height > (select ceiling_height_limit_l from limits)) or ceiling_height is null)
 ),        
-- основной запрос
-- месяц размещения объявления
  exposition_month as (
	select extract(month from a.first_day_exposition) as exposition_month,
	   	   count(distinct a.id) as total_advertisement,
	   	   round(avg(last_price / total_area)) as avg_price_open,
	   	   round(avg(total_area)) as avg_total_area_open
	from real_estate.advertisement a
	full join real_estate.flats f using(id)
	full join real_estate.type t using(type_id)
	where id in (select * from filtered_id)
	  and t.type = 'город'
	  and extract (year from first_day_exposition) in (2015, 2016, 2017, 2018)
	group by exposition_month
),
-- месяц закрытия объявления
	close_month as (
		select extract(month from (a.first_day_exposition + a.days_exposition::integer)) close_month,
	   		   count(distinct id) total_close,
	   		   round(avg(last_price / total_area)) as avg_price_close,
	   		   round(avg(total_area)) as avg_total_area_close
		from real_estate.advertisement a
		full join real_estate.flats f using(id)
		full join real_estate.type t using(type_id)
		where a.days_exposition is not null 
		  and id in (select * from filtered_id)
		  and t.type = 'город'
		  and extract (year from first_day_exposition) in (2015, 2016, 2017, 2018)
		group by close_month
)
select 
	  case 
		when exposition_month = 1 then 'Январь'
		when exposition_month = 2 then 'Февраль'
		when exposition_month = 3 then 'Март'
		when exposition_month = 4 then 'Апрель'
		when exposition_month = 5 then 'Май'
		when exposition_month = 6 then 'Июнь'
		when exposition_month = 7 then 'Июль'
		when exposition_month = 8 then 'Август'
		when exposition_month = 9 then 'Сентябрь'
		when exposition_month = 10 then 'Октябрь'
		when exposition_month = 11 then 'Ноябрь'
		when exposition_month = 12 then 'Декабрь'
	  end as month, 
	   total_advertisement as total_open,
	   -- total_close, 
	   -- round(total_advertisement / sum(total_advertisement) over(), 3) as share_open,
	   avg_price_open
	   -- avg_total_area_open,
	   -- row_number() over(order by total_advertisement desc) as rank_open,
	   -- round(total_close / sum(total_close) over(), 3) as share_close
	   -- avg_price_close, 
	   -- avg_total_area_close,
	   -- row_number() over(order by total_close desc) as rank_open
from exposition_month em
inner join close_month cm on em.exposition_month = cm.close_month
order by exposition_month
--
-- Периоды активности публикации и снятия объявлений 
-- |month	    |total_open|total_close|share_open|share_close|
-- |------------|----------|-----------|----------|-----------|
-- |Январь		|		735|	   1225|	 0.052|		 0.093|
-- |Февраль 	|	   1369|	   1048|	 0.097|		 0.079|
-- |Март		|	   1119|	   1071|	 0.080|		 0.081|
-- |Апрель		|	   1021|	   1031|	 0.073|		 0.078|
-- |Май			|		891|		729|	 0.063|		 0.055|
-- |Июнь		|	   1224|		771|	 0.087|		 0.058|
-- |Июль		|	   1149|	   1108|	 0.082|		 0.084|
-- |Август		|	   1166|	   1137|	 0.083|		 0.086|
-- |Сентябрь 	|	   1341|	   1238|	 0.095|		 0.094|
-- |Октябрь		|	   1437|	   1360|	 0.102|		 0.103|
-- |Ноябрь		|	   1569|	   1301|	 0.112|		 0.099|
-- |Декабрь		|	   1024|	   1175|	 0.073|		 0.089|
--
-- 1) Месяцы максимальной активности по публикации объявлений
--    Наибольшее число публикаций приходится на ноябрь (1569 объявлений, 11,2%), октябрь (1437, 10,2%) и февраль (1369, 9,7%).
--    Минимальная активность — в январе (735, 5,2%) и мае (891, 6,3%).
--    Таким образом, рынок оживляется после новогодних праздников и достигает пика осенью.
-- 2) Месяцы максимальной активности по снятию объявлений (продажам)
--    Лидируют октябрь (1360, 10,3%), сентябрь (1238, 9,4%) и ноябрь (1301, 9,9%).
--    Минимум снятий — в мае (729, 5,5%) и июне (771, 5,8%).
--    Основные сделки закрываются в начале осени и в октябре–ноябре.
-- 3. Совпадение периодов публикации и снятия объявлений
--    Осень — главный период активности: одновременно фиксируется и рост публикаций, и высокий уровень снятия объявлений. Это 
--    говорит о балансе спроса и предложения.
--    Весной и летом (май–июнь) рынок «остывает»: мало публикаций и мало сделок.
--    Январь — аномалия: публикаций мало (5,2%), а снятий много (9,3%). Это отражает эффект сделок, оформленных ещё в декабре, 
--    но закрытых в начале года.
--
-- Выводы:
-- 1. Основные пики активности рынка приходятся на осень (сентябрь–ноябрь), когда совпадают публикации и сделки.
-- 2. Лето и май характеризуются затишьем: низкий спрос и предложение.
-- 3. Январь выделяется высокой активностью снятия объявлений при низкой публикации, что связано с инерцией прошлогодних сделок.
--
-- Рекомендации:
-- 1. Планирование рекламных кампаний: концентрировать основные маркетинговые усилия на сентябрь–ноябрь, когда спрос и предложение совпадают.
-- 2. Управление нагрузкой: заранее увеличивать ресурс (агенты, показы, обработка заявок) к осеннему сезону.
-- 3. Работа в период спада: в мае–июне активнее продвигать объекты через акции, скидки и специальные ипотечные предложения для 
--    компенсации сезонного снижения интереса.
-- 4. Январская стратегия: использовать низкий поток новых публикаций, чтобы усилить продвижение объектов, выставленных заранее, и 
--    привлечь внимание покупателей.

-- Крреляция между кол-вом объявлений и средней стоимостью квадратного метра
-- |month		|total_open|avg_price_open|
-- |------------|----------|--------------|
-- |Январь		|		735|	  106106.0|
-- |Февраль		|	   1369|	  103059.0|
-- |Март		|	   1119|	  102430.0|
-- |Апрель 		|	   1021|	  102632.0|
-- |Май			|		891|	  102465.0|
-- |Июнь		|	   1224|	  104802.0|
-- |Июль		|	   1149|	  104489.0|
-- |Август		|	   1166|	  107035.0|
-- |Сентябрь 	|	   1341|	  107563.0|
-- |Октябрь		|	   1437|	  104065.0|
-- |Ноябрь		|	   1569|	  105049.0|
-- |Декабрь		|	   1024|	  104775.0|
--

-- 1. Сезонная динамика цен
--  	Минимальные значения средней цены кв. м приходятся на март (102 430 ₽/м²) и май (102 465 ₽/м²).
--  	Постепенный рост начинается с июня и достигает пика в сентябре (107 563 ₽/м²) и августе (107 035 ₽/м²).
--  	В ноябре–декабре цены несколько снижаются (104–105 тыс. ₽/м²).
-- 2. Динамика количества объявлений
--  	Минимум по количеству — январь (735) и май (891).
--  	Пик активности публикаций — ноябрь (1569) и октябрь (1437).
--  	Таким образом, больше всего объявлений выставляется в период осеннего сезона, что совпадает с ростом цен.
-- 3. Зависимость цен от сезона
--  	Весна (март–май): низкая цена и относительно меньшее количество объявлений — рынок перегружен дешевыми предложениями.
--  	Лето–осень (июнь–сентябрь): рост цен на фоне увеличения числа публикаций, что говорит о высокой активности покупателей.
--  	Конец года (октябрь–декабрь): много новых публикаций, но цена немного снижается, так как рынок насыщается.
-- 
-- Выводы:
-- Цены и количество объявлений зависят от сезона: весной — спад, летом–осенью — рост, в конце года — стабилизация.
-- Пик цен и активности приходится на август–сентябрь, что совпадает с возвращением покупателей после отпусков.
-- Высокая корреляция между числом объявлений и ценой: когда активность рынка увеличивается (лето–осень), растут и цены.
-- 
-- Рекомендации:
-- Весна (март–май): Активнее стимулировать спрос (ипотечные программы, скидки, акции). Подчёркивать в рекламе доступность 
-- — «лучшая цена сезона».
-- Лето–осень (июнь–сентябрь): Использовать пик цен для максимизации прибыли при продаже. Усилить маркетинг и показы, так 
-- как это период наибольшей готовности покупателей к сделкам.
-- Октябрь–декабрь: Учитывать насыщение рынка: предлагать конкурентные условия, акцентировать внимание на срочности 
-- («успей купить до конца года»). Для собственников — объяснять, что выставление объекта в этот период требует гибкости в цене.


-- 3. Анализ рынка недвижимости лен. области
-- определим аномальные значения (выбросы) по значению перцентилей:
with limits as (
    select  
        percentile_disc(0.99) within group (order by total_area) as total_area_limit,
        percentile_disc(0.99) within group (order by rooms) as rooms_limit,
        percentile_disc(0.99) within group (order by balcony) as balcony_limit,
        percentile_disc(0.99) within group (order by ceiling_height) as ceiling_height_limit_h,
        percentile_disc(0.01) within group (order by ceiling_height) as ceiling_height_limit_l
    from real_estate.flats     
),
-- найдём id объявлений, которые не содержат выбросы:
filtered_id as(
    select id
    from real_estate.flats  
    where 
        total_area < (select total_area_limit from limits)
        and (rooms < (select rooms_limit from limits) or rooms is null)
        and (balcony < (select balcony_limit from limits) or balcony is null)
        and ((ceiling_height < (select ceiling_height_limit_h from limits)
            and ceiling_height > (select ceiling_height_limit_l from limits)) or ceiling_height is null)
)
-- основной запрос
select
	city, 
	count(id) as total_ad_per_city,
	round(count(days_exposition) / count(id)::numeric, 4) as share_sold,
	round(avg(last_price / total_area)) as avg_price_sqrm,
	round(avg(total_area)) as avg_total_area,
	round(avg(days_exposition)) as avg_days_exposition,
	round(percentile_disc(0.5) within group (order by days_exposition)) mediana_days_exposition
from real_estate.flats f 
left join real_estate.advertisement a using(id)
left join real_estate.city c using(city_id)
where city <> 'Санкт-Петербург' and id in (select * from filtered_id)
group by city
having round((count(id) filter(where days_exposition is not null)) / count(id)::numeric, 4) < 1 
order by total_ad_per_city desc
limit 10

-- Топ-10 городов Ленинградской области по количеству объявлений о продаже квартиры
--
-- |city		   |total_ad_per_city|share_sold|avg_price_sqrm|avg_total_area|avg_days_exposition|mediana_days_exposition|
-- |---------------|-----------------|----------|--------------|--------------|-------------------|-----------------------|
-- |Мурино		   |			  568|	  0.9366|		85968.0|		  44.0|			  	 149.0|				      74.0|
-- |Кудрово		   |			  463|	  0.9374|		95420.0|		  46.0|			  	 161.0|				      73.0|
-- |Шушары		   |			  404|	  0.9257|		78832.0|		  54.0|			  	 152.0|				      90.0|
-- |Всеволожск 	   |			  356|	  0.8567|		69053.0|		  56.0|			  	 190.0|				     117.0|
-- |Парголово	   |			  311|	  0.9260|		90273.0|		  51.0|			  	 156.0|				      77.0|
-- |Пушкин		   |			  278|	  0.8309|	   104159.0|		  60.0|			  	 197.0|				     127.0|
-- |Гатчина		   |			  228|	  0.8904|		69005.0|		  51.0|			  	 188.0|				      99.0|
-- |Колпино		   |			  227|	  0.9207|		75212.0|		  53.0|			  	 147.0|				      80.0|
-- |Выборг		   |			  192|	  0.8750|		58670.0|		  57.0|			  	 182.0|				     107.0|
-- |Петергоф	   |			  154|	  0.8831|		85412.0|		  52.0|			  	 197.0|				      99.0|
-- ...

-- 1) Где наиболее активно публикуют объявления?
-- Лидеры по количеству объявлений:
-- Мурино (568)
-- Кудрово (463)
-- Шушары (404)
-- Всеволожск (356)
-- Парголово (311)
-- Это города-спутники Санкт-Петербурга с активно развивающейся жилой застройкой и высоким спросом.
--
-- 2) Где самая высокая доля снятых объявлений (продаж)?
-- Лидеры по доле закрытых объявлений (share_sold):
-- Кудрово — 0,9374
-- Мурино — 0,9366
-- Парголово — 0,9260
-- Шушары — 0,9257
-- Колпино — 0,9207
-- → В этих локациях больше 92% объявлений снимаются с публикации, что указывает на высокую вероятность успешной продажи.
-- 
-- 3) Средняя стоимость и площадь квартир
-- Самые дорогие:
-- Пушкин — 104 159 ₽/м², площадь 60 м²
-- Кудрово — 95 420 ₽/м², площадь 46 м²
-- Парголово — 90 273 ₽/м², площадь 51 м²
--
-- Самые дешёвые:
-- Выборг — 58 670 ₽/м², площадь 57 м²
-- Гатчина — 69 005 ₽/м², площадь 51 м²
-- Всеволожск — 69 053 ₽/м², площадь 56 м²
-- → Стоимость варьируется от 58 тыс. ₽/м² (Выборг) до 104 тыс. ₽/м² (Пушкин).
-- → Средняя площадь колеблется от 44 м² (Мурино) до 60 м² (Пушкин).
--
-- 4) Длительность экспозиции (скорость продаж)
-- Самые быстрые продажи (меньше 160 дней в среднем):
-- Колпино — 147 дней, медиана 80
-- Мурино — 149 дней, медиана 74
-- Шушары — 152 дня, медиана 90
-- Парголово — 156 дней, медиана 77
--
-- Самые долгие продажи (≈190–200 дней):
-- Пушкин — 197 дней, медиана 127
-- Петергоф — 197 дней, медиана 99
-- Всеволожск — 190 дней, медиана 117
-- Гатчина — 188 дней, медиана 99
-- Выборг — 182 дня, медиана 107
-- → В пригородах (Мурино, Кудрово, Парголово) квартиры продаются значительно быстрее, чем в старых центрах (Пушкин, Петергоф).
--
-- Общие выводы
-- Основные точки активности — Мурино, Кудрово и Шушары, где сосредоточен массовый сегмент новостроек.
-- Наибольшая вероятность успешной продажи в Кудрово, Мурино и Парголово — здесь более 92% объявлений доходят до сделки.
-- Цены сильно варьируются: от доступного сегмента (Выборг, Гатчина, Всеволожск) до премиального (Пушкин, Кудрово, Парголово).
-- Скорость продаж выше в районах массовой застройки, ниже — в городах с более дорогим или специфичным жильём (Пушкин, Петергоф).
-- 
-- Рекомендации:
-- Фокусироваться на пригородах массовой застройки (Мурино, Кудрово, Парголово): 
--  	Это самые динамичные рынки с высокой конверсией объявлений в сделки. 
-- 	 	Стоит наращивать присутствие в этих локациях.
-- Для премиальных районов (Пушкин, Петергоф):
--  	Усилить маркетинг и индивидуальный подход к продаже.
--  	Подчёркивать уникальные характеристики объектов (большая площадь, престижность района).
-- Для доступных сегментов (Выборг, Гатчина, Всеволожск):
--  	Делать упор на ипотечные продукты и инвестиционную привлекательность.
--  	Продвижение для покупателей, ориентированных на цену.
-- Сокращение времени экспозиции:
--  	В «медленных» районах внедрять инструменты ускоренной продажи: акции, торги, спецпредложения.
-- 	 	В «быстрых» районах — усиливать конкуренцию за клиента через сервис и скорость сделки.





















